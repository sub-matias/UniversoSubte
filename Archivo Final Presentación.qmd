---
title: "Universo Subte Publicitario"
subtitle: "Modelos de clasificaci贸n crom谩tica: enfoques asistidos por inteligencia artificial"
author: "Mat铆as Salto, Aleksander Dietrichson"
date: Nov. 09/2022
format: revealjs
editor: visual
---

## Introducci贸n

```{r}
#| include: false
library(tidyverse) #Manipulaci贸n de datos y gr谩ficos
library(googledrive) #Acceso al ecosistema de Google
library(googlesheets4) #Acceso a la base de datos
my_files <- dir("R",full.names = TRUE)
for(archivo in my_files){
  source(archivo)
  cat("Procesando:", archivo, "\n")
}
```

### Estudios de la comunicaci贸n en tr谩nsito y en tiempos de espera

-   El mundo de los mensajes publicitarios en el Subte de la Ciudad de Buenos Aires

-   An谩lisis cuantitativo de los colores de las publicidades gr谩ficas

    -   El uso de software estad铆stico R: entorno de trabajo, acceso y manipulaci贸n de datos, an谩lisis y representaciones gr谩ficas.

## 1锔 Librer铆as

-   Herramientas de trabajo:

    1.  Librer铆as y paquetes {tidyverse} {magick} y {googledrive}
    2.  Funciones creadas para el an谩lisis de los colores

## 2锔 Base de datos: prueba piloto

Naturaleza de las publicidades gr谩ficas analizadas:

1.  Fotograf铆as de viajes personales en el Subte L铆nea B (2018 - 2022)
2.  Publicidades de acceso p煤blico, fuentes nacionales e internacionales:
    -   Presentes en todas las L铆neas de Subte

    -   Selecci贸n intermitente de los 煤ltimos 21 a帽os (2001 - 2022)
3.  Filtro de selecci贸n: representaci贸n del tiempo social y las formas de vida en la Ciudad de Buenos Aires

## 3锔 Elaboraci贸n de funciones y gr谩ficos

### La organizaci贸n del caos que produce el an谩lisis cuantitativo

-   Funciones creadas para el estudio de los colores de las publicidades y el acceso a datos factibles de an谩lisis:
    -   C贸digos HEX

    -   Valores RGB

```{r}
#| include: false
#Acceso a los archivos locales
my_data <- read_rds("tmp/file_info.rds")
```

##  Analizar foto

Acceso a los colores: La necesidad de manipular y transformar los datos y la creaci贸n de data frames basados en teor铆a RGB

```{r}
AD_FibertelM36 <- image_read("tmp/Subte B_2004_Fibertel---Vas-M谩s-R谩pido.jpg")
plot(AD_FibertelM36)
```

##  Fibertel Subte*pass*: teor铆a HEX

#### Primera aproximaci贸n

```{r}
#| echo: false
AD_FibertelM36 <- "tmp/Subte B_2004_Fibertel---Vas-M谩s-R谩pido.jpg"
analizar_foto(AD_FibertelM36)
```

#### Caos inicial

```{r}
tmp1_AF_Fibertel <- image_read("tmp/Subte B_2004_Fibertel---Vas-M谩s-R谩pido.jpg")
tmp1_AF_Fibertel
as.raster(tmp1_AF_Fibertel) %>% head(5)
```

##  Fibertel Subte*pass*: organizaci贸n HEX

#### B煤squeda de los HEX predominantes en el caos

```{r}
#| echo: false
tmp1_AF_Fibertel %>%
  as.raster() %>%
  as.matrix() %>%
  as.vector() %>%
  head()
```

```{r}
#| echo: false
mis_colores <- tmp1_AF_Fibertel %>% 
  as.raster() %>% 
  as.matrix() %>% 
  as.vector() 
```

#### Deconstrucci贸n de los HEXs en columnas

```{r}
#| echo: false
my_data_AF_Fibertel <- data.frame(
  R = str_sub(mis_colores,2,3),
  G = str_sub(mis_colores,4,5),
  B = str_sub(mis_colores,6,7),
  A = str_sub(mis_colores,8,9)
)

my_data_AF_Fibertel  %>% head(15)
```

##  Fibertel Subte*pass*: algoritmo y HEXs dominantes

```{r}
#| echo: false
my_data_AF_Fibertel %>% 
  mutate(
    Red = stringr::str_sub(R,1,1) %>% stringr::str_c("0"),
    Green = stringr::str_sub(G,1,1) %>% stringr::str_c("0"),
    Blue = stringr::str_sub(B,1,1) %>% stringr::str_c("0"),
    Alpha = stringr::str_sub(A,1,1) %>% stringr::str_c("0")
      ) -> my_data_AF_Fibertel

my_data_AF_Fibertel <- my_data_AF_Fibertel %>% 
  mutate(color_nuevo = paste0("#",Red,Green,Blue))

my_data_AF_Fibertel %>% 
  group_by(color_nuevo) %>% 
  tally(sort=TRUE) %>% 
  head(30) -> tmp

tmp %>% 
  ggplot(aes(color_nuevo,n))+
  geom_col(fill = tmp$color_nuevo)
```

##  Visualizar RGB

Ensayo de representaci贸n gr谩fica de valores RGB a铆slados

```{r}
#| echo: false
ADs <- read_rds("tmp/file_info.rds")
AD_CocaCola <- paste0("tmp/",ADs$filename[19])
AD_CocaCola1 <- image_read("tmp/Subte B_2018_Coca-Cola, Coca-Cola. Sent铆 el verano, sent铆 el sabor..jpeg")
plot(AD_CocaCola1)
```

##  Visualizar RGB: Coca Cola

Aproximaci贸n reducida de lectura

```{r}
#| echo: false
colores_barchart(AD_CocaCola)
AD_Actron <- magick::image_read(AD_CocaCola)
```

##  Visualizar RGB: M煤ltiples publicidades

Ejemplo de sistematizaci贸n de an谩lisis:

-   Observar la fuerza de los valores mediante distribuci贸n

-   Mediante data frames

```{r}
#| results: asis
#| echo: false 
for(i in 1:3){
  cat("  \n## Imagen ", i,"\n")
  cat("::: {layout=\"[[1,1]]\"}","\n")
  mi_filename <- paste0("tmp/",ADs$filename[i])
  colores_barchart(mi_filename) %>% plot()
  #cat("\n\n")
  mi_imagen <- magick::image_read(mi_filename)
  plot(mi_imagen)
  cat(":::\n\n")
}
# i = 1
# mi_filename <- paste0("tmp/",ADs$filename[i])
```

##  Colores primarios

Representaci贸n combinada y el sinf铆n de valores posibles

```{r}
#| echo: false
  AD_KitKat <-image_read("tmp/Subte B_2018_KitKat.jpeg")
plot(AD_KitKat)
to_RGB_df(AD_KitKat) -> my_data_colores_primarios
```

##  Colores primarios: c谩lculo de distancias

```{r}
colores_primarios %>% 
  select(-value) %>% 
  knitr::kable(caption = "Colores Primarios")
#Ver colores primarios en tabla
```

##  Colores primarios: valores HEX

```{r}
#| echo: false
my_data2_AD_KitKat <- to_RGB_df(AD_KitKat)
cp <- colores_primarios
my_data2_AD_KitKat$color_name <- 
  purrr::pmap(my_data2_AD_KitKat,~{
    dist_vec <- sqrt((..1-cp$R)^2+(..2-cp$G)^2+(..3-cp$B)^2)
    res <- which.min(dist_vec)
    cp$color_name[[res]] 
    # res
  }) %>% unlist()
my_data2_AD_KitKat <- my_data2_AD_KitKat %>% 
  left_join(colores_primarios %>% select(color_name, hex))

my_color_scale <- colores_primarios$hex
names(my_color_scale) <- colores_primarios$color_name
my_data2_AD_KitKat %>% 
  group_by(color_name,hex) %>% 
  count() %>% 
  ggplot(aes(x=color_name,y=n,fill=color_name))+
  geom_col()+
  scale_fill_manual(values = my_color_scale)+
   theme(legend.position="none")
```

##  Esquema de color

Funci贸n de redondeo flexible sobre la publicidad

```{r}
AD_Viajar <- image_read("tmp/Subte B_2008_Compra-Tu-Paquete-Por-Tel茅fono---Serial-M30.jpg")
plot(AD_Viajar)
```

##  Esquema de color

1.  Calculamos los valores RGB del Subtepass en un data frame

```{r}
round_to_any <- function (x, accuracy, f = round) 
{
  f(x/accuracy) * accuracy
}
round_RGB_df <- function(df, accuracy, f = round, max_val = 255){
  df %>% 
    mutate(
      R = round_to_any(R, accuracy, f),
      G = round_to_any(G, accuracy, f),
      B = round_to_any(B, accuracy, f)
    ) %>% 
    mutate(
      R = ifelse(R > max_val, max_val, R ),
      G = ifelse(G > max_val, max_val, G ),
      B = ifelse(B > max_val, max_val, B ),
      )
}
my_data3 <- to_RGB_df(AD_Viajar)
head(my_data3)
```

2.  Redondeo a un valor espec铆fico. Ejemplo: al 5 m谩s cercano

```{r}
my_data3 %>% 
  round_RGB_df(accuracy = 5) %>% 
  head()
```

##  Esquema de color: representaci贸n gr谩fica

```{r}
#| echo: false
esquema_de_color(AD_Viajar, accuracy = 60)
```

##  Esquema de color: otras publicidades

```{r}
AD_Flybondi <- image_read("tmp/Subte A_2018_Flybondi.jpeg")
to_RGB_df(AD_Flybondi) -> my_data_colores_primarios_bondi
plot(AD_Flybondi)
```

##  Esquema de color: Flybondi

```{r}
esquema_de_color(AD_Flybondi, accuracy = 75)
```

##  Modelo de regresi贸n log铆stica

```{r}
my_data <- read_rds("./modelos/my_data2.Rds")
model <- read_rds("./modelos/my_model2.Rds")
```

-   Modelo sencillo con tres t茅rminos

-   No analiza las interacciones entre los colores

-   Basado en 45 imagenes clasificado por un humano (F)

-   Input: El promedio de los colores en la foto (Red, Green, Blue)

<<<<<<< HEAD
=======

>>>>>>> b782d85d82b5eefa4095481663b962a62a9a81ea
$$
logit(p_i) = \beta_0 + \beta_R+\beta_G+\beta_B
$$

##  Coeficientes

Expresados en **logaritmos de la raz贸n de momios**

```{r}
#| echo: true
coef(model)
```

$$
logit(p_i) = \beta_0 + \beta_R+\beta_G+\beta_B \\
logit(p_i)= 2.63604699+\\
(-0.12782665\times{Red})+\\
(0.09122828\times{Green})+\\
(0.01935391\times{Blue})
$$

##  Ejemplos

```{r}
#| echo: true
my_data[1,] %>% 
  select(Red, Green, Blue)
```

```{r}
#| include: false
my_coef <- coef(model)
my_sum = sum(my_coef[2:4]*my_data[1,c("Red","Green","Blue")])+my_coef[[1]]
my_percentage <- exp(my_sum)/(1+exp(my_sum))
```

<<<<<<< HEAD
$$
\begin{align}2.63604699\\+(-0.12782665\times\color{red}{85.8014})\\+(0.09122828\times\color{green}{94.8045 })\\\underline{+(0.01935391\times\color{blue}{103.8965})    }\\=\underline{\underline{2.327996}}\end{align}
=======
##  Ejemplos

$$
\begin{align}
2.63604699\\
+(-0.12782665\times\color{red}{85.8014})\\
+(0.09122828\times\color{green}{94.8045 })\\
\underline{+(0.01935391\times\color{blue}{103.8965})    }\\
=\underline{\underline{2.327996}}
\end{align}
>>>>>>> b782d85d82b5eefa4095481663b962a62a9a81ea
$$

##  Ejemplos: interpretar resultado

-   Expresados en **logaritmos de la raz贸n de momios**

-   Se puede convertir en porcentaje con:

$$
p = {e^{\beta_0 + \beta_R+\beta_G+\beta_B }\over{1+e^{{\beta_0 + \beta_R+\beta_G+\beta_B }}}}\\
={e^{2.327996}\over{1+e^{2.327996}}}\\
=0.9111693 \sim 91.11\%
$$

##  Ejemplo: hacerlo directamente en R

```{r}
#| echo: true
  predict(model,newdata = my_data[1,], type="response")
```

##  Visualizar el modelo

```{r}
#| echo: false
#| warning: false
tmp_df2 <-
  data.frame(
    pred = predict(model),
    hp = ifelse(my_data$pred_dura=="Fr铆o",1,0)
  )
tmp_df2 %>% 
  ggplot(aes(y=hp,x=pred))+
  geom_point()+
  xlim(-4, 4)+
  geom_function(fun=function(x){
    (1 / (1 + exp(-x)))
    }, color = "red", lty=2, lwd=1)+
  theme(axis.text.x=element_blank(),
      axis.ticks.x=element_blank(),
      axis.text.y=element_blank(),
      axis.ticks.y=element_blank())
```

##  Comentarios finales

```{r}
FinalAD <- image_read("Eidan.jpg")
plot(FinalAD)
```

-   Algoritmo de enfoque

-   Dimensi贸n cualitativa de la tesina: tiempos sociales y formas de vida en la publicidad
